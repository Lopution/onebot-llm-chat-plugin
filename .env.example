# =========================================
# Mika Bot 环境变量示例（复制为 .env / .env.prod）
# =========================================
# 说明：
# - 本文件只保留“必填 + 常用”配置，确保开箱即用
# - 更多高级配置请看 docs/api/config.md

# =========================
# NoneBot 基础配置（常用）
# =========================
DRIVER=~fastapi
HOST=0.0.0.0
PORT=8080
LOG_LEVEL=INFO
# 严格启动模式：true 时，适配器/插件加载失败将直接退出（默认 false，失败仅 warning 并降级）
# MIKA_STRICT_STARTUP=false

# =========================
# Mika API（必填其一）
# =========================
# 必须至少配置 MIKA_API_KEY 或 MIKA_API_KEY_LIST 其中之一
MIKA_API_KEY=""
# MIKA_API_KEY_LIST=["key1", "key2"]

# API 基础地址
MIKA_BASE_URL=""

# 模型名称（按你的账号可用模型调整）
MIKA_MODEL="gemini-3-pro-high"
MIKA_FAST_MODEL="gemini-2.5-flash-lite"
# 可选：多任务模型（为空时自动回退到 MIKA_FAST_MODEL）
# MIKA_TASK_FILTER_MODEL=""
# MIKA_TASK_SUMMARIZER_MODEL=""
# MIKA_TASK_MEMORY_MODEL=""

# =========================
# 身份与权限（必填）
# =========================
# 你的 QQ 号（用于管理权限；不配置会直接启动失败）
MIKA_MASTER_ID=0

# 建议配置（非必填，但推荐）
MIKA_MASTER_NAME="Sensei"
MIKA_BOT_DISPLAY_NAME="Mika"

# 群白名单（留空=全允许）
# 注意：OneBot v12 的 group_id 可能是字符串，这里依然可以写数字或字符串
# MIKA_GROUP_WHITELIST=[123456789]

# =========================
# 可选：联网搜索
# =========================
# SERPER_API_KEY=""

# =========================
# 可选：Core Runtime（Stage C，remote-only）
# =========================
# 已收敛为 remote-only：适配层通过 HTTP Core Service 调用核心
# MIKA_CORE_RUNTIME_MODE="remote"
# MIKA_CORE_REMOTE_BASE_URL="http://127.0.0.1:8080"
# MIKA_CORE_REMOTE_TIMEOUT_SECONDS=60
# MIKA_CORE_SERVICE_TOKEN=""
# 自定义工具插件模块（module.path 或 module.path:ClassName）
# MIKA_TOOL_PLUGINS=["my_tools.weather_plugin:Plugin"]
# MCP 服务配置（JSON 数组）
# MIKA_MCP_SERVERS=[{"name":"weather","command":"npx","args":["-y","@mcp/weather"]}]

# =========================
# 可选：WebUI（可视化管理）
# =========================
# MIKA_WEBUI_ENABLED=false
# MIKA_WEBUI_TOKEN=""
# MIKA_WEBUI_BASE_PATH="/webui"

# Azure OpenAI 配置示例：
# LLM_PROVIDER="azure_openai"
# LLM_BASE_URL="https://YOUR_RESOURCE.openai.azure.com/openai/deployments/YOUR_DEPLOYMENT"
# LLM_API_KEY="your-azure-api-key"

# Ollama 本地配置示例：
# LLM_PROVIDER="openai_compat"
# LLM_BASE_URL="http://localhost:11434/v1"
# LLM_API_KEY=""
# LLM_MODEL="llama3"

# =========================
# 可选：代理（外网受限环境）
# =========================
# HTTP_PROXY="http://127.0.0.1:7890"
# HTTPS_PROXY="http://127.0.0.1:7890"
# NO_PROXY="localhost,127.0.0.1"

# =========================
# 可选：可观测性
# =========================
# 使用 MIKA_* 前缀
# /metrics 是否启用 Prometheus 文本导出
# MIKA_METRICS_PROMETHEUS_ENABLED=true
# /health 是否主动探测 API 连通性（默认关闭，避免额外开销）
# MIKA_HEALTH_CHECK_API_PROBE_ENABLED=false
# MIKA_HEALTH_CHECK_API_PROBE_TIMEOUT_SECONDS=3.0
# MIKA_HEALTH_CHECK_API_PROBE_TTL_SECONDS=30

# =========================
# 高级：OneBot 兼容性（通常不需要改）
# =========================
# 离线消息同步通常依赖非标准 API（get_group_msg_history 等），默认关闭以提升兼容性
# MIKA_OFFLINE_SYNC_ENABLED=false
# 长回复分段发送（无人工延迟）
# MIKA_MESSAGE_SPLIT_ENABLED=false
# MIKA_MESSAGE_SPLIT_THRESHOLD=300
# 长回复图文兜底（forward 或引用失败后，将文本渲染为图片发送）
# MIKA_LONG_REPLY_IMAGE_FALLBACK_ENABLED=true
# MIKA_LONG_REPLY_IMAGE_MAX_CHARS=12000
# MIKA_LONG_REPLY_IMAGE_MAX_WIDTH=960
# MIKA_LONG_REPLY_IMAGE_FONT_SIZE=24
# 兼容保留：历史分片配置，当前主链路不再使用
# MIKA_LONG_MESSAGE_CHUNK_SIZE=800
# 空回复本地快速重试次数（仅传输层，不重跑整条业务链）
# MIKA_EMPTY_REPLY_LOCAL_RETRIES=1
# 空回复本地重试间隔（秒）
# MIKA_EMPTY_REPLY_LOCAL_RETRY_DELAY_SECONDS=0.4
# 传输层超时本地重试次数（仅重试超时，不重跑业务链）
# MIKA_TRANSPORT_TIMEOUT_RETRIES=1
# 传输层超时重试间隔（秒）
# MIKA_TRANSPORT_TIMEOUT_RETRY_DELAY_SECONDS=0.6
# 空回复是否触发业务级上下文降级重试（默认关闭，便于排障）
# MIKA_EMPTY_REPLY_CONTEXT_DEGRADE_ENABLED=false
# 业务级上下文降级最大层级（仅在上项为 true 时生效）
# MIKA_EMPTY_REPLY_CONTEXT_DEGRADE_MAX_LEVEL=2
# 上下文模式：legacy=历史兼容，structured=结构化（推荐）
# MIKA_CONTEXT_MODE="structured"
# 上下文最大轮次（优先于按条数截断）
# MIKA_CONTEXT_MAX_TURNS=30
# 上下文软 token 上限（估算）
# - >0: 固定预算
# - <=0: 自动预算（按模型上下文上限的 82% 推算，并做安全上限裁剪）
# MIKA_CONTEXT_MAX_TOKENS_SOFT=100000
# 是否启用上下文摘要压缩（默认关闭）
# MIKA_CONTEXT_SUMMARY_ENABLED=false
# 是否启用话题化摘要（按批次提炼群聊主题）
# MIKA_TOPIC_SUMMARY_ENABLED=false
# 话题化摘要触发批次（每 N 条新消息触发一次）
# MIKA_TOPIC_SUMMARY_BATCH=25
# 多模态严格模式（清理不合法历史消息块）
# MIKA_MULTIMODAL_STRICT=true
# 引用图片说明（best-effort）
# MIKA_QUOTE_IMAGE_CAPTION_ENABLED=true
# 引用图片说明模板（仅构造文本，不触发额外模型调用）
# MIKA_QUOTE_IMAGE_CAPTION_PROMPT="[引用图片共{count}张]"
# 引用消息解析超时（秒）
# MIKA_QUOTE_IMAGE_CAPTION_TIMEOUT_SECONDS=3.0
# 上下文 trace 日志（采样）
# MIKA_CONTEXT_TRACE_ENABLED=false
# MIKA_CONTEXT_TRACE_SAMPLE_RATE=1.0
# Active Reply（LTM 风格）门控
# MIKA_ACTIVE_REPLY_LTM_ENABLED=true
# MIKA_ACTIVE_REPLY_PROBABILITY=1.0
# MIKA_ACTIVE_REPLY_WHITELIST=["123456789"]
# 群聊相关性过滤（降低无意义回复）
# MIKA_RELEVANCE_FILTER_ENABLED=false
# MIKA_RELEVANCE_FILTER_MODEL=""

# =========================
# 可选：语义匹配（主动发言话题检测 + 长期记忆向量编码）
# =========================
# 默认使用 bge-small-zh-v1.5（fastembed 内置中文模型）
# MIKA_SEMANTIC_ENABLED=true
# MIKA_SEMANTIC_MODEL="BAAI/bge-small-zh-v1.5"
# MIKA_SEMANTIC_ONNX_PATH="/path/to/e5-small-int8-onnx/"
# MIKA_FASTEMBED_CACHE_DIR=""
# MIKA_SEMANTIC_THRESHOLD=0.4

# 长期记忆（跨会话记住用户信息，需要语义模型支持）
# MIKA_MEMORY_ENABLED=false
# MIKA_MEMORY_SEARCH_TOP_K=5
# MIKA_MEMORY_MIN_SIMILARITY=0.5
# MIKA_MEMORY_MAX_AGE_DAYS=90
# MIKA_MEMORY_EXTRACT_INTERVAL=3
# ReAct 记忆检索（多源：话题摘要/用户档案/长期记忆/知识库）
# MIKA_MEMORY_RETRIEVAL_ENABLED=false
# MIKA_MEMORY_RETRIEVAL_MAX_ITERATIONS=3
# MIKA_MEMORY_RETRIEVAL_TIMEOUT=15.0

# 知识库 RAG（文档块向量检索）
# MIKA_KNOWLEDGE_ENABLED=false
# MIKA_KNOWLEDGE_DEFAULT_CORPUS="default"
# MIKA_KNOWLEDGE_SEARCH_TOP_K=5
# MIKA_KNOWLEDGE_MIN_SIMILARITY=0.5
# MIKA_KNOWLEDGE_AUTO_INJECT=false
# MIKA_KNOWLEDGE_AUTO_INJECT_TOP_K=3
# MIKA_KNOWLEDGE_CHUNK_MAX_CHARS=450
# MIKA_KNOWLEDGE_CHUNK_OVERLAP_CHARS=80

# =========================
# 高级：内部路径与图片处理（通常不需要改）
# =========================
# MIKA_DATA_DIR="./data"
# MIKA_CONTEXT_DB_PATH="./data/mika_chat/contexts.db"
# MIKA_IMAGE_CACHE_DIR="./data/mika_chat/image_cache"
# MIKA_ALLOW_WSRV_GIF_CONVERT=0
